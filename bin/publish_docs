#!/bin/bash
#
# Generates Doxygen docs and pushes to Github GH-Pages
# See: https://massenz.github.io/distlib/

set -e

BASEDIR=$(dirname $0)

if [[ ! -e ${BASEDIR}/../bin/get_version ]]; then
    olddir=$(pwd)
    cd ${BASEDIR}/../build
    make get_version
    cp bin/get_version ../bin/
    cd ${olddir}
fi

# Exporting variables, so they will be available in the Doxyfile as $() vars.
export branch=${1:-$(git rev-parse --abbrev-ref HEAD)}
export version=$(${BASEDIR}/get_version)
export outdir=/tmp/apiserver

doxygen

git checkout gh-pages
cp -r ${outdir}/html/* ./
git add .
git commit -m"Published docs; Release ${version}"
git push

echo "Checking out branch ${branch}"
git checkout ${branch}
